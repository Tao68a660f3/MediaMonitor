# 媒体同步调试终端 (MediaMonitor)

基于 WPF 开发的媒体信息同步工具，专为嵌入式显示屏（OLED/LCD）调试设计。支持 Windows 全局媒体抓取（SMTC）、逐字歌词解析、以及高度可自定义的二进制/文本双模串口协议。

## 🌟 核心特性

* **全自动媒体抓取**：自动识别 Windows 当前播放的音乐应用（网易云、QQ音乐、Spotify 等）。
* **逐字歌词同步**：支持 `.lrc` 格式，不仅能同步整行，还**支持高级模式下的逐字（Word-by-word）显示**。
* **智能行控算法**：
* **物理行限制**：严格控制发送行数，适配 12864、OLED 等小尺寸屏幕。
* **翻译占行可选**：支持翻译行独立占用物理行，或与原文合并显示。
* **差分增量发送**：仅在内容变化时发送数据，极大地节省串口带宽。


* **双模式切换**：
* **高级模式 (0xAA)**：结构化二进制协议，包含校验位，适合稳定通信。
* **退化 RAW 模式**：**直接发送纯文本 + 换行符，适合快速验证显示效果。**


* **工业级日志**：控制台式自动清理逻辑，防止长时间运行导致的内存溢出。

![](/screenshots/运行截图.png)
![](/screenshots/示意图.jpg)
![](/screenshots/示意图2.jpg)
![](/screenshots/示意图3.jpg)

---

## 🛠 串口协议说明 (高级模式)

所有数据包采用统一格式：
`0xAA [指令号] [长度] [载荷] [校验和]`
*(校验和 = 指令 + 长度 + 所有载荷字节的低 8 位)*

| 指令 (Cmd) | 功能描述 | 载荷说明 |
| --- | --- | --- |
| **0x10** | 媒体元数据 | 标题长度+标题、歌手长度+歌手、专辑长度+专辑 |
| **0x11** | 播放状态同步 | 1B(状态) + 4B(当前ms) + 4B(总长度ms) |
| **0x12** | 原文行同步 | 内容字符串 (UTF-8/GB2312) |
| **0x13** | 翻译行同步 | 翻译内容字符串 |
| **0x14** | 逐字动态行 | 4B(开始时间) + 1B(词数) + [2B偏移+1B长度+文本]*N |

---

## 🚀 快速开始

1. **配置**：
* 设置 `设置.json` 或通过界面指定歌词路径。
* 输入框已做防呆处理，仅支持数字，支持中文输入法拦截。


2. **连接**：
* 选择串口号与波特率（默认 115200）。
* 调整“刷新率”：建议 50ms（逐字模式）或 100ms-200ms（普通模式）。


3. **运行**：
* 点击“连接串口”，播放音乐，观察 `HexPreview` 的实时协议解析流。



---

## 📂 项目结构

* `SmtcService.cs`: 调用 Windows 运行时 API 抓取媒体状态。
* `LyricService.cs`: 负责歌词搜索、解析及行匹配逻辑。
* `SerialService.cs`: 核心协议封包与硬件通信逻辑。
* `MainWindow.xaml.cs`: 包含“物理行熔断算法”与 UI 调度核心。

---

## 🔧 开发调试

* **刷新率调整**：`_uiTimer` 间隔可调，同步包频率为刷新率的 10 倍分频。
* **内存保护**：日志控件 `HexPreview` 超过 100 行自动重置。
* **编码支持**：完美支持 `UTF-8` 和 `GB2312`，适配不同单片机字库。

---

> **Note:** 这是一个追求“逻辑完美”的项目，每一行代码都经过了极限拉扯与调试。

